---
title: SQL-视图
date: 2020-04-21 10:40:40
categories:    
- 计算机基础
- 数据库
tags:
- SQL
- 数据库
toc: true
---
# 视图简介
视图是一个虚拟表，其内容由查询定义。同真实表一样，视图包含一系列带有名称的列和行数据，但视图并不是数据库真实存储的数据表。

视图是从一个、多个表或者视图中导出的表，包含一系列带有名称的数据列和若干条数据行。视图并不同于数据表，它们的区别在于以下几点：
* 视图不是数据库中真实的表，而是一张虚拟表，其结构和数据是建立在对数据中真实表的查询基础上的。
* 存储在数据库中的查询操作 SQL 语句定义了视图的内容，列数据和行数据来自于视图查询所引用的实际表，引用视图时动态生成这些数据。
* 视图没有实际的物理记录，不是以数据集的形式存储在数据库中的，它所对应的数据实际上是存储在视图所引用的真实表中的。
* 视图是数据的窗口，而表是内容。表是实际数据的存放单位，而视图只是以不同的显示方式展示数据，其数据来源还是实际表。
* 视图是查看数据表的一种方法，可以查询数据表中某些字段构成的数据，只是一些 SQL 语句的集合。从安全的角度来看，视图的数据安全性更高，使用视图的用户不接触数据表，不知道表结构。
* 视图的建立和删除只影响视图本身，不影响对应的基本表。

视图与表在本质上虽然不相同，但视图经过定义以后，结构形式和表一样，可以进行查询、修改、更新和删除等操作。同时，视图具有如下优点：

**1.定制用户数据，聚焦特定的数据**

在实际的应用过程中，不同的用户可能对不同的数据有不同的要求。例如，当数据库同时存在时，如学生基本信息表、课程表和教师信息表等多种表同时存在时，可以根据需求让不同的用户使用各自的数据。学生查看修改自己基本信息的视图，安排课程人员查看修改课程表和教师信息的视图，教师查看学生信息和课程信息表的视图。

**2.简化数据操作**

在使用查询时，很多时候要使用聚合函数，同时还要显示其他字段的信息，可能还需要关联到其他表，语句可能会很长，如果这个动作频繁发生的话，可以创建视图来简化操作。

**3.提高基表数据的安全性**

视图是虚拟的，物理上是不存在的。可以只授予用户视图的权限，而不具体指定使用表的权限，来保护基础数据的安全。

**4.共享所需数据**

通过使用视图，每个用户不必都定义和存储自己所需的数据，可以共享数据库中的数据，同样的数据只需要存储一次。

**5.更改数据格式**

通过使用视图，可以重新格式化检索出的数据，并组织输出到其他应用程序中。

**6.重用SQL语句**

视图提供的是对查询操作的封装，本身不包含数据，所呈现的数据是根据视图定义从基础表中检索出来的，如果基础表的数据新增或删除，视图呈现的也是更新后的数据。视图定义后，编写完所需的查询，可以方便地重用该视图。

<font color=red>注意：要区别视图和数据表的本质，即视图是基于真实表的一张虚拟的表，其数据来源均建立在真实表的基础上。</font>
* 创建视图需要足够的访问权限。
* 创建视图的数目没有限制。
*  视图可以嵌套，即从其他视图中检索数据的查询来创建视图。
* 视图不能索引，也不能有关联的触发器、默认值或规则。
* 视图可以和表一起使用。
* 视图不包含数据，所以每次使用视图时，都必须执行查询中所需的任何一个检索操作。如果用多个连接和过滤条件创建了复杂的视图或嵌套了视图，可能会发现系统运行性能下降得十分严重。因此，在部署大量视图应用时，应该进行系统测试。

# 创建视图(CREATE VIEW)
视图可以建立在一张表中，也可以建立在多张表中。

## 基本语法
使用CREATE VIEW 语句来创建视图
>语法格式：CREATE VIEW<视图名>AS<SELECT语句>

语法说明如下：
* <视图名>：指定视图的名称。该名称在数据库中必须是唯一的，不能与其他表或视图同名。
* <SELECT语句>：指定创建视图的 SELECT 语句，可用于查询多个基础表或源视图。

对于创建视图中的SELECT语句存在以下限制：
* 用户除了拥有 CREATE VIEW 权限外，还具有操作中涉及的基础表和其他视图的相关权限。
* SELECT语句不能引用系统或用户变量。
* SELECT语句不能包含 FROM子句中的子查询。
* SELECT语句不能引用预处理语句参数。

视图定义中引用的表或视图必须存在。但是，创建完视图后，可以删除定义引用的表或视图。可使用 CHECK TABLE 语句检查视图定义是否存在这类问题。视图定义中允许使用 ORDER BY 语句，但是若从特定视图进行选择，而该视图使用了自己的 ORDER BY 语句，则视图定义中的 ORDER BY 将被忽略。视图定义中不能引用TEMPORARY表（临时表），不能创建TEMPORARY视图。WITH CHECK OPTION 的意思是，修改视图时，检查插入的数据是否符合 WHERE 设置的条件。

## 创建基于单表的视图

实例1：在单个数据表上创建视图。在 tb_students_info 表上创建一个名为 view_students_info 的视图
```sql
mysql> CREATE VIEW view_students_info
    -> AS SELECT * FROM tb_students_info;
Query OK, 0 rows affected (0.04 sec)

mysql> SELECT * FROM view_students_info;
+----+------+---------+------+------+--------+---------------------+
| id | name | dept_id | age  | sex  | height | login_date          |
+----+------+---------+------+------+--------+---------------------+
|  1 | peng |       2 |   25 | F    |    222 | 1000-01-01 00:00:00 |
|  2 | jun  |       2 |   12 | F    |    222 | 1000-01-01 00:00:01 |
|  3 | Gui  |       1 |   44 | M    |    170 | 1000-01-01 00:00:01 |
|  4 | Feng |       2 |   32 | F    |    175 | 1000-01-01 00:00:01 |
|  5 | Qi   |       0 |   22 | M    |    170 | 1000-01-01 00:00:01 |
+----+------+---------+------+------+--------+---------------------+
5 rows in set (0.00 sec)
```
实例2：在 tb_students_info 表上创建一个名为 v_students_info 的视图。
```sql
mysql> CREATE VIEW v_students_info (s_id, s_name, d_id, s_age, s_sex, s_height, s_date) AS SELECT id, name, dept_id, age, sex, height, login_date FROM tb_students_info;
Query OK, 0 rows affected (0.03 sec)

mysql> SELECT * FROM v_students_info;
+------+--------+------+-------+-------+----------+---------------------+
| s_id | s_name | d_id | s_age | s_sex | s_height | s_date              |
+------+--------+------+-------+-------+----------+---------------------+
|    1 | peng   |    2 |    25 | F     |      222 | 1000-01-01 00:00:00 |
|    2 | jun    |    2 |    12 | F     |      222 | 1000-01-01 00:00:01 |
|    3 | Gui    |    1 |    44 | M     |      170 | 1000-01-01 00:00:01 |
|    4 | Feng   |    2 |    32 | F     |      175 | 1000-01-01 00:00:01 |
|    5 | Qi     |    0 |    22 | M     |      170 | 1000-01-01 00:00:01 |
+------+--------+------+-------+-------+----------+---------------------+
5 rows in set (0.01 sec)
```
## 创建基于多表的视图
可以在两个以上的表中创建视图，使用 CREATE VIEW 语句创建。
## 查询视图
视图一经定义之后，就可以如同查询数据表一样，使用 SELECT 语句查询视图中的数据，语法和查询基础表的数据一样。主要应用在以下几个方面：
* 使用视图重新格式化检索出的数据
* 使用视图简化复杂的表连接
* 使用视图过滤数据
>语法格式：DESCRIBE 视图名；

实例3：DESCRIBE 语句查看视图 v_students_info 的定义
```sql
mysql> DESC v_students_info;
+----------+--------------+------+-----+---------+-------+
| Field    | Type         | Null | Key | Default | Extra |
+----------+--------------+------+-----+---------+-------+
| s_id     | int(11)      | NO   |     | NULL    |       |
| s_name   | varchar(255) | YES  |     | NULL    |       |
| d_id     | int(11)      | YES  |     | NULL    |       |
| s_age    | int(11)      | YES  |     | NULL    |       |
| s_sex    | char(10)     | YES  |     | NULL    |       |
| s_height | int(11)      | YES  |     | NULL    |       |
| s_date   | datetime     | YES  |     | NULL    |       |
+----------+--------------+------+-----+---------+-------+
7 rows in set (0.00 sec)
```
# 修改视图(ALTER VIEW)
修改数据库中存在的视图，当基本表的某些字段发生变化时，可以通过修改视图来保持与基本表的一致性。
>语法格式：ALTER VIEW <视图名> AS <SELECT语句>

语法说明：
* <视图名>：指定视图的名称。该名称在数据库中必须是唯一的，不能与其他表或视图同名。
* <SELECT 语句>：指定创建视图的 SELECT 语句，可用于查询多个基础表或源视图。

<font color=red>对于 ALTER VIEW 语句的使用，需要用户具有针对视图的 CREATE VIEW 和 DROP 权限，以及由 SELECT 语句选择的每一列上的某些权限。</font>

## 修改视图内容
视图是一个虚拟表，实际的数据来自于基本表，所以通过插入、修改和删除操作更新视图中的数据，实质上是在更新视图所引用的基本表的数据。某些视图是可更新的。也就是说，可以使用 UPDATE、DELETE 或 INSERT 等语句更新基本表的内容。对于可更新的视图，视图中的行和基本表的行之间必须具有一对一的关系

<font color=red>对视图的修改就是对基本表的修改，因此在修改时，要满足基本表的数据定义</font>

视图包含以下结构中的任何一种，它就是不可更新的：
* 聚合函数 SUM()、MIN()、MAX()、COUNT() 等。
* DISTINCT 关键字。
* GROUP BY 子句。
* HAVING 子句。
* UNION 或 UNION ALL 运算符。
* 位于选择列表中的子查询。
* FROM 子句中的不可更新视图或包含多个表。
* WHERE 子句中的子查询，引用 FROM 子句中的表。
* ALGORITHM 选项为 TEMPTABLE（使用临时表总会使视图成为不可更新的）的时候。

实例1：使用 ALTER 语句修改视图 view_students_info。
```sql
mysql> ALTER VIEW view_students_info
    -> AS SELECT id,name,age
    -> FROM tb_students_info;
Query OK, 0 rows affected (0.03 sec)

mysql> DESC view_students_info;
+-------+--------------+------+-----+---------+-------+
| Field | Type         | Null | Key | Default | Extra |
+-------+--------------+------+-----+---------+-------+
| id    | int(11)      | NO   |     | NULL    |       |
| name  | varchar(255) | YES  |     | NULL    |       |
| age   | int(11)      | YES  |     | NULL    |       |
+-------+--------------+------+-----+---------+-------+
3 rows in set (0.01 sec)
# 用户可以通过视图来插入、更新、删除表中的数据，因为视图是一个虚拟的表，没有数据。通过视图更新时转到基本表上进行更新，如果对视图增加或删除记录，实际上是对基本表增加或删除记录。
```

实例2：使用 UPDATE 语句更新视图 view_students_info。
```sql
mysql> UPDATE view_students_info
    -> SET age=25 WHERE id=1;
Query OK, 0 rows affected (0.05 sec)
Rows matched: 1  Changed: 0  Warnings: 0

mysql> SELECT * FROM view_students_info;
+----+------+------+
| id | name | age  |
+----+------+------+
|  1 | peng |   25 |
|  2 | jun  |   12 |
|  3 | Gui  |   44 |
|  4 | Feng |   32 |
|  5 | Qi   |   22 |
+----+------+------+
5 rows in set (0.00 sec)
```
<font color=red>修改视图的名称可以先将视图删除，然后按照相同的定义语句进行视图的创建，并命名为新的视图名称。</font>

# 删除视图(DROP VIEW)
删除视图时，只能删除视图的定义，不会删除数据。
>语法格式：DROP VIEW <视图名1> [ , <视图名2> …]

其中：<视图名>指定要删除的视图名。DROP VIEW 语句可以一次删除多个视图，但是必须在每个视图上拥有 DROP 权限。

实例：删除 v_students_info 视图。
```sql
mysql> DROP VIEW IF EXISTS v_students_info;
Query OK, 0 rows affected (0.00 sec)

mysql> SHOW CREATE VIEW v_students_info;
ERROR 1146 (42S02): Table 'test.v_students_info' doesn't exist
# v_students_info 视图已不存在，将其成功删除。
```